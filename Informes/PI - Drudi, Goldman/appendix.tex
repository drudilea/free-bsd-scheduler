\appendix

\section{Apéndice 1: Archivos de diferencias}\label{appendix:apA}

\subsection{\textit{sched\_switch} (v12 a v13): Firma de la función y variables}\label{appendix:apA1}

\begin{lstlisting}[language=diff]
- void sched_switch(struct thread *td, struct thread *newtd, int flags)
+ void sched_switch(struct thread *td, int flags)
{
+   struct thread *newtd;
    struct mtx *tmtx;
    struct td_sched *ts;
    struct proc *p;
    int preempted;

-   tmtx = NULL;
+   tmtx = &sched_lock;
    ts = td_get_sched(td);
    p = td->td_proc;

    THREAD_LOCK_ASSERT(td, MA_OWNED);
...
}
\end{lstlisting}



\subsection{\textit{sched\_switch} (v12 a v13): Cambio de posición del bloque que bloquea el hilo previo al \textit{resource\_expulse\_thread}}\label{appendix:apA2}

\begin{lstlisting}[language=diff]
+   if (td->td_lock != &sched_lock) {
+   	mtx_lock_spin(&sched_lock);
+   	tmtx = thread_lock_block(td);
+   	mtx_unlock_spin(tmtx);
+   }

   if ((td->td_flags & TDF_NOLOAD) == 0)
   	sched_load_rem();

    td->td_lastcpu = td->td_oncpu;
    preempted = (td->td_flags & TDF_SLICEEND) == 0 && (flags & SW_PREEMPT) != 0;
    td->td_flags &= ~(TDF_NEEDRESCHED | TDF_SLICEEND);
    td->td_owepreempt = 0;
    td->td_oncpu = NOCPU;

    resource_expulse_thread(td, flags);

-   if (td->td_lock != &sched_lock) {
-   	mtx_lock_spin(&sched_lock);
-   	tmtx = thread_lock_block(td);
-   	mtx_unlock_spin(tmtx);
-   }
...
\end{lstlisting}


\subsection{\textit{sched\_switch} (v12 a v13): Selección y ejecución de un nuevo thread}\label{appendix:apA3}

\begin{lstlisting}[language=diff]
+   newtd = choosethread();
-   if (newtd) {
-       /*
-        * The thread we are about to run needs to be counted
-        * as if it had been added to the run queue and selected.
-        * It came from:
-        * * A preemption
-        * * An upcall
-        * * A followon
-        */
-       KASSERT((newtd->td_inhibitors == 0),
-           ("trying to run inhibited thread"));
-       newtd->td_flags |= TDF_DIDRUN;
-           TD_SET_RUNNING(newtd);
-       if ((newtd->td_flags & TDF_NOLOAD) == 0)
-           sched_load_add();
-       if (ts->ts_runq != &runq){
-           resource_fire_net(newtd, TRAN_UNQUEUE + (PCPU_GET(cpuid)*CPU_BASE_TRANSITIONS));
-       }
-       else{
-           resource_fire_net(newtd, TRAN_FROM_GLOBAL_CPU + (PCPU_GET(cpuid)*CPU_BASE_TRANSITIONS));
-       }
-   } else {
-       newtd = choosethread();
-       MPASS(newtd->td_lock == &sched_lock);
-   }

    resource_execute_thread(newtd, PCPU_GET(cpuid));

\end{lstlisting}

\end{document}

